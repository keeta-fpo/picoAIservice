<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>แผนที่ Leaflet PC version</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
  <style>
       html,body,#map { height: 100%; margin: 0; padding: 0; }
    #map { min-height: 400px; }
    .control-panel { 
      background: white; 
      padding: 10px; 
      border-radius: 5px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
      margin: 8px;
      position: relative;
      z-index: 1000;
    }
    .location-buttons { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn { 
      background: #4CAF50; 
      color: white; 
      padding: 8px 12px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px;
      flex: 1;
      min-width: 120px;
      max-width: 180px;
      text-align: center;
    }
    .btn:hover { background: #45a049; }
    .btn.active { background: #2196F3; }
   #results {
      position:fixed;
      right:8px;
      bottom:8px;
      background:#fff;
      padding:8px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      max-width:320px;
      font-size:13px;
      white-space:pre-wrap;
      max-height:200px;
      overflow-y:auto;
      z-index: 9999;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .usage-section {
      margin-bottom: 15px;
    }
    .usage-title {
      font-weight: bold;
      color: #2196F3;
      margin-bottom: 5px;
    }
    .usage-steps {
      margin-left: 20px;
    }
    .usage-step {
      margin-bottom: 5px;
    }
    @media (max-width: 768px) {
      .location-buttons {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        max-width: none;
      }
    }
  </style>
  <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
</head>
<body>
  <div class="control-panel">
    <label>สถานที่ที่เลือกได้:</label>
    <div class="location-buttons">
      <button class="btn" onclick="centerMap(13.7563, 100.5018, 'กรุงเทพฯ')">กระทรวงการคลัง</button>
      <!-- <button class="btn" onclick="centerMap(13.8600, 100.5140, 'นนทบุรี')">นนทบุรี</button> -->
      <button class="btn" id="toggle-distance" onclick="toggleDistanceMode()">คำนวณระยะห่าง 2 จุด</button>
      <button class="btn" id="toggle-add" onclick="toggleAddPoints()">คำนวนระยะทางหลายจุด</button>
      <button class="btn" onclick="computeHaversine()">คำนวณ Haversine</button>
      <button class="btn" onclick="clearPoints()">ล้างจุดทั้งหมด</button>
      <button class="btn" onclick="showUsageGuide()" style="background: #FF9800;">วิธีใช้งาน</button>
      <button class="btn" onclick="computeDistancesFromStart()" style="background: #9C27B0;">เปรียบเทียบระยะจากจุดเริ่มต้น</button>
    </div>
  </div>
  
  <div id="map"></div>
  <div id="results"></div>

  <!-- Modal สำหรับแสดงวิธีใช้งาน -->
  <div id="usageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeUsageGuide()">&times;</span>
      <h2>วิธีคำนวณระยะห่างระหว่าง 2 จุด</h2>
      
      <div class="usage-section">
        <div class="usage-steps">
          <div class="usage-step">1. คลิกปุ่ม "คำนวณระยะห่าง 2 จุด" เพื่อเปิดโหมดคำนวณระยะห่าง</div>
          <div class="usage-step">2. คลิกบนแผนที่เพื่อเลือกจุดที่ 1 (จะปรากฏมาร์กเกอร์สีฟ้า)</div>
          <div class="usage-step">3. คลิกบนแผนที่อีกครั้งเพื่อเลือกจุดที่ 2 (จะปรากฏมาร์กเกอร์สีแดง)</div>
          <div class="usage-step">4. ระบบจะคำนวณระยะห่างระหว่าง 2 จุดและวาดเส้นเชื่อมระหว่างจุดทั้งสอง</div>
          <div class="usage-step">5. ผลลัพธ์จะแสดงในกล่องผลลัพธ์ที่มุมขวาล่างของหน้าจอ</div>
        </div>
      </div>
    </div>
  </div>

  <script>
      // CONFIG: ปรับไฟล์ข้อมูลและลักษณะ marker ได้จากบล็อกนี้
      const CONFIG = {
        dataFile: '6com.jsonl',
        marker: {
          radius: 8,
          fillOpacity: 0.85,
          weight: 1,
          hoverOpenPopup: true,
          useBlack: true    // true = ใช้วงกลมสีดำทั้งขอบและเติม
        }
      };

      // ฟังก์ชันเพิ่ม markers ของบริษัทจากข้อมูล JSONL
      function addCompanyMarkers(companies) {
        companies.forEach((company, i) => {
          if (!company.details) return;
          company.details.forEach(detail => {
            const [address, phones, coords] = detail;
            if (!Array.isArray(coords) || (coords[0] === 0 && coords[1] === 0)) return;

            const popupContent = `
              <div class="info-popup">
                <h3>${company.name}</h3>
                <p class="address"><strong>ที่อยู่:</strong> ${address}</p>
                <p class="phones"><strong>โทร:</strong> ${phones}</p>
                <p class="date"><strong>วันที่:</strong> ${company.date}</p>
                <p><strong>เลขที่ใบอนุญาติ:</strong> ${company.case_id}</p>
              </div>
            `;

            // สร้าง circleMarker — ใช้สีดำตาม CONFIG.marker.useBlack
            const fill = CONFIG.marker.useBlack ? 'black' : undefined;
            const stroke = CONFIG.marker.useBlack ? 'black' : undefined;
            const circle = L.circleMarker([coords[0], coords[1]], {
              radius: CONFIG.marker.radius,
              color: stroke,
              fillColor: fill,
              fillOpacity: CONFIG.marker.fillOpacity,
              weight: CONFIG.marker.weight
            }).addTo(map);

            circle.bindPopup(popupContent);
            if (CONFIG.marker.hoverOpenPopup) {
              circle.on('mouseover', () => circle.openPopup());
              circle.on('mouseout', () => circle.closePopup());
            }
          });
        });
      }

      // โหลดข้อมูล JSONL (one JSON object per line) แล้วเพิ่ม markers
      async function loadCompanyData() {
        const resultsEl = document.getElementById('results');
        resultsEl.textContent = 'กำลังโหลดข้อมูลบริษัท...';
        try {
          const resp = await fetch(CONFIG.dataFile);
          const txt = await resp.text();
          const lines = txt.trim() ? txt.trim().split('\n') : [];
          const companies = lines.map(l => JSON.parse(l));
          addCompanyMarkers(companies);
          // ยืนยันให้แผนที่กลับไปที่จุดเริ่มต้นเสมอหลังโหลดข้อมูล
          if (typeof startLatLng !== 'undefined' && map) {
            map.setView(startLatLng, 12);
          }
         // เก็บข้อมูลบริษัทไว้สำหรับคำนวณระยะทาง
         window.allCompanies = companies;
          resultsEl.textContent = `โหลดข้อมูลบริษัท ${companies.length} รายการ`;
        } catch (err) {
          console.error('Error loading company data:', err);
          resultsEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลบริษัท';
        }
      }

      // ตั้งค่าเริ่มต้น: กรุงเทพฯ (ใช้เสมอ)
      const startLatLng = [13.7563, 100.5018];
      const map = L.map('map', { center: startLatLng, zoom: 12 });
      // โหลดข้อมูลบริษัทหลังจาก map ถูกสร้างและพร้อมใช้งาน
      // เรียกโหลดข้อมูล โดยจะบังคับให้ map กลับไปที่ startLatLng หลังโหลดเสร็จ
      loadCompanyData();
    // ตัวแปรจัดการจุดหลายจุด
    let addingPoints = false;
    let distanceMode = false;
    let multiPoints = [];   // array ของ {lat, lng}
    let multiMarkers = [];
    let distancePoints = []; // สำหรับเก็บ 2 จุดสำหรับคำนวณระยะห่าง
    let distanceMarkers = []; // มาร์กเกอร์สำหรับจุดระยะห่าง
    let distanceLine = null; // เส้นเชื่อมระหว่าง 2 จุด
    
    // ชั้นแผนที่พื้นฐานที่เลือกได้ (ใช้ leaflet-providers)
    const baseLayers = {
      "OpenStreetMap": L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map),
      "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron'),
      "Esri WorldImagery": L.tileLayer.provider('Esri.WorldImagery')
    };
    L.control.layers(baseLayers).addTo(map);

    // เพิ่มเครื่องมือมาตรวัด
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // มาร์กเกอร์ตัวอย่างและป๊อปอัพ
    L.marker(startLatLng).addTo(map)
      .bindPopup('<b>กรุงเทพฯ</b><br>ตำแหน่งเริ่มต้น').openPopup();

    // ตัวแปรสำหรับอนิเมชัน
    let centerMarker = null;
    
    // แสดงคู่มือการใช้งาน
    function showUsageGuide() {
      document.getElementById('usageModal').style.display = 'block';
    }
    
    // ปิดคู่มือการใช้งาน
    function closeUsageGuide() {
      document.getElementById('usageModal').style.display = 'none';
    }
    
    // สลับโหมดเพิ่มจุดบนแผนที่
    function toggleAddPoints() {
      addingPoints = !addingPoints;
      distanceMode = false;
      document.getElementById('toggle-add').textContent = addingPoints ? 'ยกเลิกเพิ่มจุด' : 'เพิ่มจุด';
      document.getElementById('toggle-add').classList.toggle('active', addingPoints);
      document.getElementById('toggle-distance').classList.remove('active');
      map.getContainer().style.cursor = addingPoints ? 'crosshair' : '';
      updateResults();
    }
    
    // สลับโหมดคำนวณระยะห่างระหว่าง 2 จุด
    function toggleDistanceMode() {
      distanceMode = !distanceMode;
      addingPoints = false;
      document.getElementById('toggle-distance').textContent = distanceMode ? 'ยกเลิกคำนวณระยะ' : 'คำนวณระยะห่าง 2 จุด';
      document.getElementById('toggle-distance').classList.toggle('active', distanceMode);
      document.getElementById('toggle-add').classList.remove('active');
      map.getContainer().style.cursor = distanceMode ? 'crosshair' : '';
      updateResults();
      
      if (!distanceMode) {
        clearDistancePoints();
      }
    }
    
    // เพิ่มมาร์กเมื่อคลิก (เก็บเป็นค่า lat/lng)
    function addPoint(latlng) {
      multiPoints.push({ lat: latlng.lat, lng: latlng.lng });
      const m = L.marker([latlng.lat, latlng.lng]).addTo(map)
        .bindPopup(`จุด ${multiPoints.length}<br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
      multiMarkers.push(m);
    }
    
    // เพิ่มจุดสำหรับคำนวณระยะห่าง
    function addDistancePoint(latlng) {
      // ถ้ามีจุดแล้ว 2 จุด ให้เริ่มใหม่
      if (distancePoints.length >= 2) {
        clearDistancePoints();
      }
      
      distancePoints.push({ lat: latlng.lat, lng: latlng.lng });
      const pointNumber = distancePoints.length;
      const m = L.marker([latlng.lat, latlng.lng], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + 
                  (pointNumber === 1 ? 'blue' : 'red') + '.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map)
        .bindPopup(`จุดที่ ${pointNumber}<br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
      distanceMarkers.push(m);
      
      // ถ้ามี 2 จุดแล้ว ให้คำนวณระยะห่างและวาดเส้น
      if (distancePoints.length === 2) {
        calculateDistance();
        drawDistanceLine();
      }
      
      updateResults();
    }
    
    // คำนวณระยะห่างระหว่าง 2 จุด
    function calculateDistance() {
      if (distancePoints.length !== 2) return;
      
      const p1 = distancePoints[0];
      const p2 = distancePoints[1];
      const distance = haversine(p1.lat, p1.lng, p2.lat, p2.lng);
      
      const result = `ระยะห่างระหว่าง 2 จุด:\nจุดที่ 1: ${p1.lat.toFixed(6)}, ${p1.lng.toFixed(6)}\nจุดที่ 2: ${p2.lat.toFixed(6)}, ${p2.lng.toFixed(6)}\nระยะทาง: ${(distance/1000).toFixed(3)} กิโลเมตร`;
      
      document.getElementById('results').textContent = result;
      console.log(result);
    }
    
    // วาดเส้นเชื่อมระหว่าง 2 จุด
    function drawDistanceLine() {
      if (distanceLine) {
        map.removeLayer(distanceLine);
      }
      
      if (distancePoints.length === 2) {
        distanceLine = L.polyline([
          [distancePoints[0].lat, distancePoints[0].lng],
          [distancePoints[1].lat, distancePoints[1].lng]
        ], {color: 'blue', weight: 3, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
      }
    }
    
    // ล้างจุดสำหรับคำนวณระยะห่าง
    function clearDistancePoints() {
      distancePoints = [];
      distanceMarkers.forEach(marker => map.removeLayer(marker));
      distanceMarkers = [];
      if (distanceLine) {
        map.removeLayer(distanceLine);
        distanceLine = null;
      }
    }
    
    // อัปเดตผลลัพธ์
    function updateResults() {
      let result = '';
      
      if (distanceMode) {
        if (distancePoints.length === 0) {
          result = 'กรุณาคลิกเพื่อเลือกจุดที่ 1';
        } else if (distancePoints.length === 1) {
          result = 'กรุณาคลิกเพื่อเลือกจุดที่ 2';
        }
      } else if (addingPoints) {
        result = `เพิ่มแล้ว ${multiPoints.length} จุด\nคลิกบนแผนที่เพื่อเพิ่มจุด`;
      }
      
      if (result) {
        document.getElementById('results').textContent = result;
      }
    }

    // Haversine formula (คืนเมตร)
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // เมตร
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // คำนวณระยะด้วย Haversine สำหรับชุดจุดที่เพิ่ม (ตามลำดับ)
    function computeHaversine() {
      if (multiPoints.length < 2) {
        alert('กรุณาเพิ่มอย่างน้อย 2 จุด');
        return;
      }
      let total = 0;
      let lines = [];
      for (let i = 0; i < multiPoints.length - 1; i++) {
        const a = multiPoints[i];
        const b = multiPoints[i+1];
        const d = haversine(a.lat, a.lng, b.lat, b.lng); // เมตร
        total += d;
        lines.push(`จาก ${i+1} → ${i+2}: ${(d/1000).toFixed(3)} km`);
      }
      const out = `ระยะรวม (Haversine): ${(total/1000).toFixed(3)} km\n` + lines.join('\n');
      document.getElementById('results').textContent = out;
      console.log(out);
    }
    
    // คำนวณระยะทางจากจุดเริ่มต้นไปยังบริษัททั้งหมด
    function computeDistancesFromStart() {
      if (!window.allCompanies || window.allCompanies.length === 0) {
        alert('กรุณาโหลดข้อมูลบริษัทก่อน');
        return;
      }
      
      const distances = [];
      window.allCompanies.forEach(company => {
        if (!company.details) return;
        company.details.forEach(detail => {
          const [address, phones, coords] = detail;
          if (!Array.isArray(coords) || (coords[0] === 0 && coords[1] === 0)) return;
          
          const distance = haversine(startLatLng[0], startLatLng[1], coords[0], coords[1]);
          distances.push({
            name: company.name,
            distance: distance,
            distanceKm: (distance / 1000).toFixed(3)
          });
        });
      });
      
      // เรียงลำดับจากใกล้ไปไกล
      distances.sort((a, b) => a.distance - b.distance);
      
      // สร้างผลลัพธ์แบบสั้น (ชื่อบริษัท + ระยะทาง)
      let output = '';
      distances.forEach((item, index) => {
        output += `${index + 1}. ${item.name} ระยะทาง: ${item.distanceKm} กิโลเมตร\n`;
      });
      
      document.getElementById('results').textContent = output;
      console.log('Distances from start:', distances);
    }
    
    // ล้างจุดทั้งหมด
    function clearPoints() {
      multiPoints = [];
      multiMarkers.forEach(marker => map.removeLayer(marker));
      multiMarkers = [];
      clearDistancePoints();
      document.getElementById('results').textContent = 'ล้างจุดทั้งหมดแล้ว';
    }
    
    // ฟังก์ชันสำหรับย้ายศูนย์กลางแผนที่ไปยังตำแหน่งที่กำหนด
    function centerMap(lat, lng, locationName) {
      const newLatLng = [lat, lng];
      
      // ย้ายแผนที่ไปยังตำแหน่งใหม่พร้อมอนิเมชัน
      map.flyTo(newLatLng, 12, {
        animate: true,
        duration: 1.2
      });
      
      // อัพเดทหรือสร้างมาร์กเกอร์ศูนย์กลาง
      if (centerMarker) {
        centerMarker.setLatLng(newLatLng);
        centerMarker.setPopupContent(`<b>${locationName}</b>`);
      } else {
        centerMarker = L.marker(newLatLng).addTo(map)
          .bindPopup(`<b>${locationName}</b>`).openPopup();
      }
    }
    
    // เมื่อคลิกที่แผนที่ ให้เพิ่มจุดถ้าโหมดเพิ่มจุดเปิดอยู่ มิฉะนั้นแสดงพิกัด
    map.on('click', function(e) {
      if (addingPoints) {
        addPoint(e.latlng);
        updateResults();
      } else if (distanceMode) {
        addDistancePoint(e.latlng);
      } else {
        L.popup()
          .setLatLng(e.latlng)
          .setContent('พิกัด: ' + e.latlng.lat.toFixed(6) + ', ' + e.latlng.lng.toFixed(6))
          .openOn(map);
      }
    });
    
    // ปิด modal เมื่อคลิกนอกพื้นที่ modal
    window.onclick = function(event) {
      const modal = document.getElementById('usageModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
    
    console.log('แผนที่ Dynamic Center พร้อมใช้งานแล้ว!');
  </script>
  </body>
</html>
