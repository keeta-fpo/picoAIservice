<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pico MAP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
  <style>
       html,body,#map { height: 100%; margin: 0; padding: 0; }
    #map { min-height: 400px; }
    .control-panel { 
      background: white; 
      padding: 10px; 
      border-radius: 5px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
      margin: 8px;
      position: relative;
      z-index: 1000;
    }
    .location-buttons { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn { 
      background: #4CAF50; 
      color: white; 
      padding: 8px 12px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px;
      flex: 1;
      min-width: 120px;
      max-width: 180px;
      text-align: center;
    }
    .btn:hover { background: #45a049; }
    .btn.active { background: #2196F3; }
   #results {
      position:fixed;
      right:8px;
      bottom:8px;
      background:#fff;
      padding:8px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      max-width:320px;
      font-size:13px;
      white-space:pre-wrap;
      max-height:200px;
      overflow-y:auto;
      z-index: 9999;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .usage-section {
      margin-bottom: 15px;
    }
    .usage-title {
      font-weight: bold;
      color: #2196F3;
      margin-bottom: 5px;
    }
    .usage-steps {
      margin-left: 20px;
    }
    .usage-step {
      margin-bottom: 5px;
    }
    @media (max-width: 768px) {
      .location-buttons {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        max-width: none;
      }
    }
  </style>
  <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
</head>
<body>
  <div class="control-panel">
    <label>สถานที่ที่เลือกได้:</label>
    <div class="location-buttons">
      <button class="btn" onclick="loadCompanyData()" style="background: #FFC107;">โหลดข้อมูลบริษัท</button>
      <button class="btn" onclick="centerMap(13.7563, 100.5018, 'อนุสาวรีย์')">อนุสาวรีย์(ศูนย์กลาง กทม.)</button>
      <button class="btn" onclick="centerMap(13.7818401,100.532494, 'กระทรวงการคลัง')">กระทรวงการคลัง</button>

      <!-- <button class="btn" onclick="centerMap(13.8600, 100.5140, 'นนทบุรี')">นนทบุรี</button> -->
      <button class="btn" id="toggle-distance" onclick="toggleDistanceMode()">คำนวณระยะห่าง 2 จุด</button>
      <button class="btn" id="toggle-add" onclick="toggleAddPoints()">คำนวนระยะทางหลายจุด</button>
      <button class="btn" onclick="computeHaversine()">คำนวณ Haversine</button>
      <button class="btn" onclick="clearPoints()">ล้างจุดทั้งหมด</button>
      <button class="btn" onclick="showUsageGuide()" style="background: #FF9800;">วิธีใช้งาน</button>
      <button class="btn" onclick="computeDistancesFromStart()" style="background: #9C27B0;">เปรียบเทียบระยะจากจุดเริ่มต้น</button>
      <button class="btn" onclick="showAllMarkers()" style="background: #4CAF50;">แสดงทั้งหมด</button>
      
      <!-- Input สำหรับพิกัดที่กำหนดเอง -->
      <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap; margin-top: 10px;">
        <input type="number" id="customLat" placeholder="ละติจูด (lat)" step="any" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px;" />
        <input type="number" id="customLng" placeholder="ลองจิจูด (lng)" step="any" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px;" />
        <button class="btn" onclick="computeFromCustomCoords()" style="background: #2196F3; min-width: auto; padding: 8px 12px;">คำนวณจากพิกัด</button>
      </div>
    </div>
  </div>
  
  <div id="map"></div>
  <div id="results"></div>

  <!-- Modal สำหรับแสดงวิธีใช้งาน -->
  <div id="usageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeUsageGuide()">&times;</span>
      <h2>วิธีคำนวณระยะห่างระหว่าง 2 จุด</h2>
      
      <div class="usage-section">
        <div class="usage-steps">
          <div class="usage-step">1. คลิกปุ่ม "คำนวณระยะห่าง 2 จุด" เพื่อเปิดโหมดคำนวณระยะห่าง</div>
          <div class="usage-step">2. คลิกบนแผนที่เพื่อเลือกจุดที่ 1 (จะปรากฏมาร์กเกอร์สีฟ้า)</div>
          <div class="usage-step">3. คลิกบนแผนที่อีกครั้งเพื่อเลือกจุดที่ 2 (จะปรากฏมาร์กเกอร์สีแดง)</div>
          <div class="usage-step">4. ระบบจะคำนวณระยะห่างระหว่าง 2 จุดและวาดเส้นเชื่อมระหว่างจุดทั้งสอง</div>
          <div class="usage-step">5. ผลลัพธ์จะแสดงในกล่องผลลัพธ์ที่มุมขวาล่างของหน้าจอ</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG: ปรับไฟล์ข้อมูลและลักษณะ marker ได้จากบล็อกนี้
    const CONFIG = {
      dataFile: 'df_bkk.jsonl',
      marker: {
        radius: 8,
        fillOpacity: 0.85,
        weight: 1,
        hoverOpenPopup: true,
        useBlack: true    // true = ใช้วงกลมสีดำทั้งขอบและเติม
      }
    };

    // Global state management
    let map, companyLayer, allCompanyMarkers = [], allCompanies = [];
    let addingPoints = false, distanceMode = false;
    let multiPoints = [], multiMarkers = [];
    let distancePoints = [], distanceMarkers = [], distanceLine = null;
    let centerMarker = null;

    // ตั้งค่าเริ่มต้น: กรุงเทพฯ (ใช้เสมอ)
    const startLatLng = [13.7818401, 100.532494];

    // Initialize map
    function initMap() {
      map = L.map('map', { center: startLatLng, zoom: 12 });
      
      // Base layers
      const baseLayers = {
        "OpenStreetMap": L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map),
        "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron'),
        "Esri WorldImagery": L.tileLayer.provider('Esri.WorldImagery')
      };
      L.control.layers(baseLayers).addTo(map);

      // Scale control
      L.control.scale({ metric: true, imperial: false }).addTo(map);

      // Company layer group
      companyLayer = L.layerGroup().addTo(map);

      // Default marker
      L.marker(startLatLng).addTo(map)
        .bindPopup(`<b>จุดเริ่มต้น</b><br>${startLatLng[0].toFixed(6)}, ${startLatLng[1].toFixed(6)}`).openPopup();

      // Map click handler
      map.on('click', function(e) {
        if (addingPoints) {
          addPoint(e.latlng);
          updateResults();
        } else if (distanceMode) {
          addDistancePoint(e.latlng);
        } else {
          L.popup()
            .setLatLng(e.latlng)
            .setContent(`พิกัด: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`)
            .openOn(map);
        }
      });

      console.log('แผนที่ Dynamic Center พร้อมใช้งานแล้ว!');
    }

    // Add company markers to layer
    function addCompanyMarkers(companies) {
      companyLayer.clearLayers();
      allCompanyMarkers = [];
      companies.forEach(company => {
        if (!company.details) return;
        company.details.forEach(detail => {
          const [address, phones, coords] = detail;
          if (!Array.isArray(coords) || coords[0] === 0 || coords[1] === 0) return;

          const popupContent = `
            <div class="info-popup">
              <h3>${company.name}</h3>
              <p class="address"><strong>ที่อยู่:</strong> ${address}</p>
              <p class="phones"><strong>โทร:</strong> ${phones}</p>
              <p class="date"><strong>วันที่:</strong> ${company.date}</p>
              <p><strong>เลขที่ใบอนุญาต:</strong> ${company.case_id}</p>
            </div>
          `;

          const fillColor = CONFIG.marker.useBlack ? 'black' : undefined;
          const strokeColor = CONFIG.marker.useBlack ? 'black' : undefined;
          const circle = L.circleMarker([coords[0], coords[1]], {
            radius: CONFIG.marker.radius,
            color: strokeColor,
            fillColor: fillColor,
            fillOpacity: CONFIG.marker.fillOpacity,
            weight: CONFIG.marker.weight
          }).addTo(companyLayer);

          circle.bindPopup(popupContent);
          if (CONFIG.marker.hoverOpenPopup) {
            circle.on('mouseover', () => circle.openPopup());
            circle.on('mouseout', () => circle.closePopup());
          }
          allCompanyMarkers.push(circle);
        });
      });
      console.log(`เพิ่ม markers สำหรับ ${companies.length} บริษัท`);
    }

    // Load company data from JSONL
    async function loadCompanyData() {
      const resultsEl = document.getElementById('results');
      resultsEl.textContent = 'กำลังโหลดข้อมูลบริษัท...';
      try {
        const resp = await fetch(CONFIG.dataFile);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        const txt = await resp.text();
        const lines = txt.trim().split('\n').filter(line => line.trim());
        const companies = lines.map(line => {
          try {
            return JSON.parse(line);
          } catch (e) {
            console.warn('Invalid JSON line:', line, e);
            return null;
          }
        }).filter(c => c);

        if (companies.length === 0) throw new Error('ไม่มีข้อมูลบริษัทในไฟล์');

        allCompanies = companies;
        addCompanyMarkers(companies);
        map.setView(startLatLng, 12);
        resultsEl.textContent = `โหลดข้อมูลบริษัท ${companies.length} รายการสำเร็จ`;
      } catch (err) {
        console.error('Error loading company data:', err);
        resultsEl.textContent = `เกิดข้อผิดพลาด: ${err.message}\nตรวจสอบไฟล์ ${CONFIG.dataFile}`;
      }
    }

    // Toggle add points mode
    function toggleAddPoints() {
      addingPoints = !addingPoints;
      distanceMode = false;
      const btn = document.getElementById('toggle-add');
      btn.textContent = addingPoints ? 'ยกเลิกเพิ่มจุด' : 'คำนวนระยะทางหลายจุด';
      btn.classList.toggle('active', addingPoints);
      document.getElementById('toggle-distance').classList.remove('active');
      map.getContainer().style.cursor = addingPoints ? 'crosshair' : '';
      updateResults();
    }

    // Toggle distance mode
    function toggleDistanceMode() {
      distanceMode = !distanceMode;
      addingPoints = false;
      const btn = document.getElementById('toggle-distance');
      btn.textContent = distanceMode ? 'ยกเลิกคำนวณระยะ' : 'คำนวณระยะห่าง 2 จุด';
      btn.classList.toggle('active', distanceMode);
      document.getElementById('toggle-add').classList.remove('active');
      map.getContainer().style.cursor = distanceMode ? 'crosshair' : '';
      updateResults();
      if (!distanceMode) clearDistancePoints();
    }

    // Add point for multi-points
    function addPoint(latlng) {
      multiPoints.push({ lat: latlng.lat, lng: latlng.lng });
      const marker = L.marker([latlng.lat, latlng.lng]).addTo(map)
        .bindPopup(`จุด ${multiPoints.length}<br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
      multiMarkers.push(marker);
    }

    // Add point for distance calculation
    function addDistancePoint(latlng) {
      if (distancePoints.length >= 2) clearDistancePoints();
      distancePoints.push({ lat: latlng.lat, lng: latlng.lng });
      const pointNumber = distancePoints.length;
      const color = pointNumber === 1 ? 'blue' : 'red';
      const marker = L.marker([latlng.lat, latlng.lng], {
        icon: L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map)
        .bindPopup(`จุดที่ ${pointNumber}<br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
      distanceMarkers.push(marker);

      if (distancePoints.length === 2) {
        calculateDistance();
        drawDistanceLine();
      }
      updateResults();
    }

    // Calculate distance between two points
    function calculateDistance() {
      if (distancePoints.length !== 2) return;
      const p1 = distancePoints[0], p2 = distancePoints[1];
      const distance = haversine(p1.lat, p1.lng, p2.lat, p2.lng); // meters
      const distanceKm10 = (distance / 1000) * 10; // คูณ 10 สำหรับการแสดงผล
      const result = `ระยะห่างระหว่าง 2 จุด:\nจุดที่ 1: ${p1.lat.toFixed(6)}, ${p1.lng.toFixed(6)}\nจุดที่ 2: ${p2.lat.toFixed(6)}, ${p2.lng.toFixed(6)}\nระยะทาง: ${distanceKm10.toFixed(3)} กิโลเมตร`;
      document.getElementById('results').textContent = result;
      console.log(result);
    }

    // Draw line between distance points
    function drawDistanceLine() {
      if (distanceLine) map.removeLayer(distanceLine);
      if (distancePoints.length === 2) {
        distanceLine = L.polyline([
          [distancePoints[0].lat, distancePoints[0].lng],
          [distancePoints[1].lat, distancePoints[1].lng]
        ], {color: 'blue', weight: 3, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
      }
    }

    // Clear distance points
    function clearDistancePoints() {
      distancePoints = [];
      distanceMarkers.forEach(marker => map.removeLayer(marker));
      distanceMarkers = [];
      if (distanceLine) {
        map.removeLayer(distanceLine);
        distanceLine = null;
      }
    }

    // Update results display
    function updateResults() {
      let result = '';
      if (distanceMode) {
        if (distancePoints.length === 0) result = 'กรุณาคลิกเพื่อเลือกจุดที่ 1';
        else if (distancePoints.length === 1) result = 'กรุณาคลิกเพื่อเลือกจุดที่ 2';
      } else if (addingPoints) {
        result = `เพิ่มแล้ว ${multiPoints.length} จุด\nคลิกบนแผนที่เพื่อเพิ่มจุด`;
      }
      if (result) document.getElementById('results').textContent = result;
    }

    // Haversine formula (returns meters) - แก้ไข R ให้ถูกต้อง (6371 km = 6,371,000 m)
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Earth radius in meters (ตรวจสอบให้แน่ใจว่าเป็น 6371000 ไม่ใช่ 637100)
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c; // ระยะทางในเมตร
      console.log(`Debug Haversine: จาก (${lat1.toFixed(4)}, ${lon1.toFixed(4)}) ไป (${lat2.toFixed(4)}, ${lon2.toFixed(4)}) = ${distance.toFixed(0)} เมตร (~${(distance/1000).toFixed(3)} km)`); // Debug log สำหรับตรวจสอบ
      return distance;
    }

    // Compute Haversine for multi-points
    function computeHaversine() {
      if (multiPoints.length < 2) {
        alert('กรุณาเพิ่มอย่างน้อย 2 จุด');
        return;
      }
      let totalKm10 = 0, lines = [];
      for (let i = 0; i < multiPoints.length - 1; i++) {
        const a = multiPoints[i], b = multiPoints[i + 1];
        const d = haversine(a.lat, a.lng, b.lat, b.lng); // meters
        const dKm10 = (d / 1000) * 10; // คูณ 10 สำหรับการแสดงผล
        totalKm10 += dKm10;
        lines.push(`จาก ${i+1} → ${i+2}: ${dKm10.toFixed(3)} km`);
      }
      const out = `ระยะรวม (Haversine x10): ${totalKm10.toFixed(3)} km\n` + lines.join('\n');
      document.getElementById('results').textContent = out;
      console.log(out);
    }

    // Compute distances from start to companies
    function computeDistancesFromStart() {
      // รีใช้ฟังก์ชันทั่วไปโดยส่ง startLatLng เป็นพิกัด
      computeDistancesFromLocation(startLatLng[0], startLatLng[1], 'จุดเริ่มต้น');
    }

    // Compute distances from custom coordinates input
    function computeFromCustomCoords() {
      const latInput = document.getElementById('customLat');
      const lngInput = document.getElementById('customLng');
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('กรุณาใส่ค่าละติจูดและลองจิจูดที่ถูกต้อง');
        return;
      }
      
      if (!allCompanies || allCompanies.length === 0) {
        alert('กรุณาโหลดข้อมูลบริษัทก่อน');
        return;
      }
      
      const locationName = 'พิกัดที่กำหนด';
      // ไม่เรียก computeDistancesFromLocation ตรงนี้ เพื่อหลีกเลี่ยงการคำนวณซ้ำ
      centerMap(lat, lng, locationName);
      
      // ล้าง input หลังคำนวณ (optional)
      latInput.value = '';
      lngInput.value = '';
    }

    // Compute distances from a given location to companies (แสดงผลเป็น x10)
    function computeDistancesFromLocation(lat, lng, locationName) {
      if (!allCompanies || allCompanies.length === 0) {
        alert('กรุณาโหลดข้อมูลบริษัทก่อน');
        return;
      }
      const distances = [];
      allCompanies.forEach(company => {
        if (!company.details) return;
        company.details.forEach(detail => {
          const [address, phones, coords] = detail;
          if (!Array.isArray(coords) || coords[0] === 0 || coords[1] === 0) return;
          const distance = haversine(lat, lng, coords[0], coords[1]); // meters
          const distanceKmDisplay = ((distance / 1000) * 10).toFixed(3); // คูณ 10 สำหรับการแสดงผล
          distances.push({
            name: company.name,
            address: address,
            distance: distance, // เก็บหน่วยเป็นเมตรสำหรับการเรียง
            distanceKm: distanceKmDisplay
          });
          if (company.name.includes('ฟินโทเปีย')) {
            console.log(`Debug บริษัท "${company.name}": ระยะทางดิบ = ${distance.toFixed(0)} m, km(x10) = ${distanceKmDisplay} (พิกัดบริษัท: ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)})`);
          }
        });
      });
      distances.sort((a, b) => a.distance - b.distance);
      let output = `ระยะทางจาก ${locationName} (${lat.toFixed(6)}, ${lng.toFixed(6)}) :\n${'='.repeat(50)}\n`;
      distances.forEach((item, index) => {
        output += `${index + 1}. ${item.name}\n   ระยะทาง: ${item.distanceKm} กิโลเมตร\n\n`;
      });
      document.getElementById('results').textContent = output;
      console.log(`Distances from ${locationName}:`, distances);
    }

    // Show all company markers
    function showAllMarkers() {
      if (allCompanyMarkers.length === 0) {
        document.getElementById('results').textContent = 'ไม่มีข้อมูลบริษัท โปรดโหลดข้อมูลก่อน';
        return;
      }
      companyLayer.clearLayers();
      allCompanyMarkers.forEach(marker => marker.addTo(companyLayer));
      map.setView(startLatLng, 12);
      document.getElementById('results').textContent = 'แสดง markers ทั้งหมดแล้ว';
    }

    // Clear all points
    function clearPoints() {
      multiPoints = [];
      multiMarkers.forEach(marker => map.removeLayer(marker));
      multiMarkers = [];
      clearDistancePoints();
      document.getElementById('results').textContent = 'ล้างจุดทั้งหมดแล้ว';
    }

    // Center map to location (updated to compute distances from new location)
    function centerMap(lat, lng, locationName) {
      const newLatLng = [lat, lng];
      map.flyTo(newLatLng, 12, { animate: true, duration: 1.2 });
      if (centerMarker) {
        centerMarker.setLatLng(newLatLng);
        centerMarker.setPopupContent(`<b>${locationName}</b>`);
      } else {
        centerMarker = L.marker(newLatLng).addTo(map)
          .bindPopup(`<b>${locationName}</b>`).openPopup();
      }
      // คำนวณระยะห่างจากตำแหน่งใหม่ (ถ้ามีข้อมูลบริษัท)
      computeDistancesFromLocation(lat, lng, locationName);
    }

    // Usage guide modal
    function showUsageGuide() {
      document.getElementById('usageModal').style.display = 'block';
    }

    function closeUsageGuide() {
      document.getElementById('usageModal').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('usageModal');
      if (event.target === modal) modal.style.display = 'none';
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
